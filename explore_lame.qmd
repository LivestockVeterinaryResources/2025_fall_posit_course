---
title: "Explore Events"
editor: source
format: 
 html:
   embed-resources: true
   toc: true
   toc-location: left
execute:
    echo: false
    message: false
    warning: false
---

```{r}
library(tidyverse)
library(arrow)
library(dtplyr)
library(DT)
library(gt)

source('functions/DT_base.R') #functions to parse remarks and protocols

events_formatted<-read_parquet('data/intermediate_files/events_formatted.parquet') |> 
   filter(event %in% c("LAME", "FOOTRIM"))

pull_date <- max(events_formatted$date_event)
farm_name <- unique(events_formatted$location_event)

herd_deno <- read_parquet('data/intermediate_files/herd_denominators.parquet') |> 
  mutate(farm = farm_name)
 
summarize_events<-events_formatted |> 
  group_by(event, protocols_remaining_after_numbers1) |> 
  summarize(count_rows=sum(n()))|>
  ungroup()%>%
  mutate(event_type = factor(protocols_remaining_after_numbers1), 
         Event = factor(event),
         event_type = if_else(is.na(event_type), "Trim Only", event_type))

```

# Check out what Lesion are being reported
```{r}
#| fig-height: 8
# count y vars

facet_order <- summarize_events %>%
  group_by(event_type) %>%
  summarise(n_y = n_distinct(event)) %>%
  arrange(desc(n_y)) %>%  # Order by most y categories
  pull(event_type)

# order events
summarize_events <- summarize_events %>%
  mutate(event_type = fct_reorder(event_type, count_rows, .fun = sum, .desc = FALSE)) 

  ggplot(summarize_events)+
  geom_bar(aes(x = event_type,
               y = count_rows, fill = event_type), stat = "identity")+
  #facet_wrap(factor(event, levels = facet_order) ~., scales = 'free')+
    facet_wrap(vars(event), ncol = 1, scales = "free")+
  coord_flip()+
  scale_fill_viridis_d()+
  theme_minimal()+
  labs(x = "",
       y = "Row Count")+
  theme(legend.position = "none",
        # axis.text.y = element_text(size = 6)
        )
```

# Table of events

```{r}
fxn_DT_base(summarize_events)
```


# process Data

```{r}

# assign lesion

source("functions/fxn_code_lesions.R")

all_lesions <- c("dd", "footrot", 'wld', "sole_ulcer","injury", 
                             "cork", "other", "hemorrhage",
                             "sole_fracture", "toe_ulcer", "thin",
                             "inf", "noninf", "toe", "axial", "lesion")

# create variables
lame_events <- events_formatted |> 
  # create lesion vars
  fxn_code_lesions(protocol_var = protocols,
                   remark_var = remark) |> 
    #select(-c(notes, remark_disease, diagnosis)) |> 
  lazy_dt() |> 
  # delete footrim if lame/footrim on same day
  group_by(location_event, id_animal, date_event) |>
  slice_min(trimonly) |> 
  ungroup() |> 
  as_tibble()

# data set to summarize
lame_events_sum <- lame_events |> 
  group_by(location_event, id_animal, date_event) |>
  summarise(across(.cols = all_of(all_lesions), max)
            )|> 
  ungroup() 

lame_events <- lame_events |> 
  select(-c(all_of(all_lesions))) |> 
  distinct(location_event, id_animal, date_event, .keep_all = TRUE) |> 
  left_join(lame_events_sum, 
            by = join_by(location_event, id_animal, date_event)) |> 
  mutate(floordate_year = floor_date(date_event, unit = 'year'))

rm(lame_events_sum)


```
# counting lifetime lamneness events
With most disease whether it is the first or 2nd event matters. The code below separates that out for the newly created diseases and also create some date and duration variables we will use later


```{r}

# count trims
lame_events_test <- lame_events |> 
  rename(farm = location_event) |> 
group_by(farm, id_animal) %>% 
  # calculate times trimmed in data set
  mutate(times_trimmed = dense_rank(date_event)) %>% 
  arrange(times_trimmed) %>%
  mutate(date_prev_event = ymd(lag(date_event, n=1)),
         # time dif for any trim type
         days_from_prev_event = date_event-date_prev_event,
         days_to_next_event = lead(days_from_prev_event, n=1),
         # determine if trim (1) or lame trim
         type_prev_trim = lag(trimonly, n=1),
         # calc for lame cows time from last trim if last was a trim
         days_from_trim = if_else(trimonly == 0 & type_prev_trim == 1,
                                date_event - date_prev_event, NA),
         days_to_next_lame = lead(days_from_trim, n=1)) %>% 
  ungroup()

# this counts lesion #
lesion_counts <- lame_events_test %>%
  filter(trimonly == 0) %>% 
  group_by(farm, id_animal) %>% 
  arrange(date_event) %>% 
  mutate(life_times_lame = as.numeric(dense_rank(date_event))) %>%
  # calc time from last lame
  mutate(date_prev_lame = lag(date_event,n = 1),
         days_between_lame = date_event - date_prev_lame) %>%
  ungroup() %>% 
  group_by(farm, id_animal, lact_number) %>% 
  # count x lame in lact
  mutate(lact_times_lame = as.numeric(dense_rank(date_event))) %>%  
  ungroup() %>% 
  #count x lesions
  group_by(farm, id_animal, dd) %>% 
  mutate(life_times_dd = if_else(dd == 1, 
                           as.numeric(dense_rank(date_event)), NA)) %>%  # needs to be NA not 0 so fill works below
  group_by(farm, id_animal, sole_ulcer) %>% 
  mutate(life_times_su = if_else(sole_ulcer == 1, 
                           as.numeric(dense_rank(date_event)), NA)) |> 
  group_by(farm, id_animal, wld) %>% 
  mutate(life_times_wld = if_else(wld == 1, 
                           as.numeric(dense_rank(date_event)), NA)) |> 
  group_by(farm, id_animal, injury) %>% 
  mutate(life_times_injury = if_else(injury == 1, 
                           as.numeric(dense_rank(date_event)), NA)) |> 
  group_by(farm, id_animal, other) %>% 
  mutate(life_times_other = if_else(other == 1, 
                           as.numeric(dense_rank(date_event)), NA)) |> 
  ungroup() %>%
  group_by(farm, id_animal, inf) %>% 
  mutate(life_times_inf = if_else(inf == 1, 
                           as.numeric(dense_rank(date_event)), NA)) |> 
  ungroup() |> 
  group_by(farm, id_animal, noninf) %>% 
  mutate(life_times_noninf = if_else(noninf == 1, 
                           as.numeric(dense_rank(date_event)), NA)) |> 
  ungroup() |> 
  #merge back to lame_events
  right_join(lame_events_test) 

# then fill NA's with 0'
lame_events2 <- lesion_counts %>%
  group_by(farm, id_animal, lact_number) %>% 
  arrange(date_event) %>% 
  # fills first row with 0 if not lame
  mutate(lact_times_lame = if_else(is.na(lact_times_lame)& 
                                     is.na(type_prev_trim),
                             0, lact_times_lame)) %>% 
  # fills rest of NA's
  fill(lact_times_lame, .direction = "down") %>% 
  # to fix if first trim in next lact = just a trim
  mutate(lact_times_lame = if_else(is.na(lact_times_lame),
                             0, lact_times_lame)) %>%
  ungroup() %>% 
  group_by(farm, id_animal) %>%
  arrange(id_animal, date_event) %>%
  # does above for all lifex's
  mutate(across(starts_with("life_time"), 
                function(x) {if_else(is.na(x) & is.na(type_prev_trim), 0, x)
  })) %>%
  fill(starts_with("life_time"), .direction = "down") |> 
  ungroup()

```
# count events

To then count all occurences diagnoses/events
  
```{r}

# this counts overall lesions 

last_year_floor <- floor_date(pull_date,"year")

lame_sum_all <- lame_events2 |> 
  filter(life_times_lame > 0) |> 
  select(-trimonly) |> 
  group_by(farm, floordate_year, lact_group_5) |> 
  summarize(across(all_of(all_lesions), \(x) sum(x, na.rm = TRUE)),
            .groups = "drop") |> 
  # Add totals by floordate_year
  bind_rows(
    lame_events2 |> 
      filter(life_times_lame > 0) |> 
      select(-trimonly) |> 
      group_by(farm, floordate_year) |> 
      summarize(across(all_of(all_lesions), \(x) sum(x, na.rm = TRUE))) |> 
      mutate(lact_group_5 = "LACT > 0")
  ) |>
  # filter out just last year
  filter(floordate_year == last_year_floor)  |> 
  pivot_longer(cols = all_of(all_lesions),
               names_to = "lesion_type",
               values_to = "count_all")

fxn_DT_base(head(lame_sum_all))

```

# count incident events

To then count first lesion occurrences.  Bases on 1st classification of any lesion in a cow's life. Could do by 1st for each lesion but harder to attribute cause to RF if skin/corium is damaged by lesion or compensation. For example if a cow gets DD and then an ulcer is the ulcer due to excessive standing time due to management or due to shifting weight to other leg due DD?
  
```{r}

# this counts first lesions 

lame_sum_first <- lame_events2 |> 
  filter(life_times_lame == 1) |> 
  select(-trimonly) |> 
  # count lesions
  group_by(farm, floordate_year, lact_group_5)%>%
  summarize(across(all_of(all_lesions), \(x) sum(x, na.rm = TRUE)))%>%
  ungroup() |>
    # Add totals by floordate_year
  bind_rows(
    lame_events2 |> 
      filter(life_times_lame == 1 ) |> 
      select(-trimonly) |> 
      group_by(farm, floordate_year) |> 
      summarize(across(all_of(all_lesions), \(x) sum(x, na.rm = TRUE))) |> 
      mutate(lact_group_5 = "LACT > 0")
  ) |>
  # filter out just 2024
  filter(floordate_year == last_year_floor) |> 
  pivot_longer(cols = all_of(all_lesions),
               names_to = "lesion_type",
               values_to = "count_1st")

fxn_DT_base(head(lame_sum_first))

```

# merge sum tables

```{r}

lesion_table <- lame_sum_all |> 
  left_join(lame_sum_first, 
            by = join_by(farm, floordate_year, lact_group_5, lesion_type))

```


# merge with denominators

To turn this into a lacational risk and account for # cows we need to merge this with the denominators we calculated earlier

```{r}


risk <- lesion_table |> 
    # filter out just 2024
  filter(floordate_year == last_year_floor & lact_group_5 != "Heifer") |> 
  left_join(herd_deno, by = join_by(farm, lact_group_5 == 'Lactation Group')) |> 
  mutate(risk_first = round(count_1st/count_lactations*100,1),
         risk_all = round(count_all/count_lactations * 100, 1),
         ) |> 
  select(-c(floordate_year))

fxn_DT_base(head(risk))


```

# create a GT table of this data for the whole herd 

```{r}

lesion_labels <- c(
  lesion = "Any Lesion",
  dd = "Digital Dermatitis",
  sole_ulcer = "Sole Ulcer",
  wld = "White Line",
  other = "Other",
  footrot = "Footrot",
  injury = "Injury",
  inf = "Infectious",
  noninf = "Non-Infectious",
  toe = "Any Toe Lesion",
  toe_ulcer = "Toe Ulcer",
  thin = "Thin Sole",
  cork = "Corkscrew"
)

risk_gt <- risk |> 
  filter(lact_group_5 == "LACT > 0") |> 
  filter(risk_first >0 & risk_all>0) |> 
  select(farm, lesion_type, risk_first, risk_all) |> 
  arrange(desc(risk_first)) |> 
  mutate(lesion_type = fct_recode(lesion_type, !!!lesion_labels)) |> 
  gt(groupname_col = "farm",
     row_group_as_column = TRUE) |> 
  tab_spanner(label = md("**% Risk for Case Type**"), columns = starts_with("risk")) |> 
  cols_label(lesion_type = "Lesion",
             risk_first = "1{{^st}}",
             risk_all = "All") |> 
    # tab_style(
    # style = cell_text(weight = "bold"),
    # locations = cells_column_spanners(everything())
    # ) |> 
  cols_align("right") |> 
  tab_footnote(footnote = "1st lifetime occurence of any lesion not of a particular lesion",
               locations = cells_column_labels(columns = risk_first)) |>
    tab_style(
    style = cell_text(align = "center", weight = "bold"),
    locations = cells_column_labels(everything())
    ) |> 
  cols_align(align = "center", columns = c(risk_first, risk_all))


risk_gt

```

# code for graph (a dynamic function)

```{r}

region_les_graph <- function(.data, 
                             facet_col = farm,
                             plot_var = lesion_type,
                             lesions = all_lesions,
                             years,
                             farms){
  # filter data
  df <- .data |> 
    filter(risk_all != 0) %>% 
    filter(time_period %in% years) |> 
    filter(lesion_type %in% lesions & farm %in% farms)
  
  # calculate min/max for graphs
  min <- df |> 
  mutate(min = min(risk_first, na.rm = TRUE)
         ) |> 
  slice_head() |>
  mutate((min = floor(min))) |> 
  select(min) 

min_limit <- min$min[1] 

max <- df |> 
  mutate(max = max(risk_all, na.rm = TRUE) 
         )|> 
  slice_head() |> 
  select(max) |> 
  mutate(max =ceiling(max)
  )
# extract max value
max_limit <- max$max[1]  

break_graph <- case_when(max_limit < 6 ~ 1,
                         max_limit > 6 & max_limit <11 ~ 2,
                         max_limit > 10 & max_limit < 51 ~ 5,
                         max_limit > 50 & max_limit < 101 ~ 10,
                         max_limit >101 ~ 20)

#graph
les_graph <- df %>%
#  group_by(farm, year) %>% 
  mutate(x_var = fct_reorder({{plot_var}}, risk_all)) %>% 
  ggplot() +
  geom_segment(aes(x = x_var, xend = x_var, 
                   y = risk_all, yend = risk_first, 
                   color = "Repeats"), 
               linewidth = 2) +
  geom_point(aes(x = x_var, y = risk_all, color = "All"), size = 6.5) +
  geom_text(aes(x_var, risk_all, label = round(risk_all, digits = 1)), 
            nudge_x = +.01, 
            color = "white", size = 2.25,
            show.legend = FALSE) +
  geom_point(aes(x = x_var, y = risk_first, color = "1st"), size = 6.5) +
  geom_text(aes(x_var, risk_first, label = round(risk_first, digits = 1)), 
            nudge_x = +.01,  
            color = "white", size = 2.25) +
  coord_flip() +
  theme_minimal() +
  xlab("") +
  ylab("# of cases per 100 cows") + 
  scale_y_continuous(limits = c(0, max_limit),
                     breaks = seq(0, max_limit, by = break_graph),
                     expand = c(0.02, 0.02)) +
  scale_x_discrete(expand = c(0.05, 0.05),
                   labels = lesion_labels) +
  scale_color_manual(name = "# of Cases", 
                     values = c("Repeats" = "#FDE725FF", #viridis colours
                                "All" = "#440154FF", 
                                "1st" = "#7ad151ff"),
                     labels = c("1st", "Repeats", "All"),
                     breaks = c("1st", "Repeats", "All")
  )+
  guides(color = guide_legend(override.aes = list(shape = c(19, NA, 19),
                                                  linetype = c(1, 1, 1)
  ),
  label.position = "bottom",
  title.position = "top",
  title.hjust = 0.5)
  )+
  theme(legend.position = "top")+
  facet_wrap(vars({{facet_col}}), ncol = 1,
             labeller = labeller(lesion_type = lesion_labels))+
  theme(strip.text = element_text(face = "bold"))
}
```

# Total Lesion Distribution

```{r}
#| label: fig_any
#| fig-cap: "**Most lesions don't seem to repeat**"
#| fig-cap-location: top


farms <- "demo"
years <- ("2025")
lesion_labels <- c(
  lesion = "Any Lesion",
  dd = "Digital Dermatitis",
  sole_ulcer = "Sole Ulcer",
  wld = "White Line",
  other = "Other",
  footrot = "Footrot",
  injury = "Injury",
  inf = "Infectious",
  noninf = "Non-Infectious",
  toe = "Any Toe Lesion",
  toe_ulcer = "Toe Ulcer",
  thin = "Thin Sole",
  cork = "Corkscrew"
)


graph_overall <- risk |> 
  filter(lact_group_5 == "LACT > 0") |> 
  region_les_graph(years = years, farms = farms)

graph_overall


```

# Lesion Distribution by Lactation Group

```{r}
#| fig-cap: "**More repeats in older cows**"
#| fig-cap-location: top
#| fig-height: 11

graph_lact <- risk |> 
  filter(lact_group_5 != "LACT > 0") |> 
  region_les_graph(years = years, farms = farms, facet_col = lact_group_5)

graph_lact

```
