---
title: Overview Options
format: 
 html:
   embed-resources: true
   toc: true
   toc-location: left
execute:
    echo: false
    message: false
    warning: false
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Load your packages here

library(tidyverse) #this includes many packages and is the main package used in nearly all data wrangling
library(arrow) #this package handles parquet files
library(skimr) #this is particularly helpful when looking at new data or finding NA values
library(waldo) #we use this to create answer keys for these exercises


```


Items presented here are potential additions to the "Overview" shiny app.

```{r}
get_unique_chars <- function(x) {
  x %>%
    # Remove commas
    gsub(",", "", .) %>%
    # Split into individual characters
    strsplit("") %>%
    # Unlist all characters from all strings
    unlist() %>%
    # Remove hyphens or empty values
    setdiff(c("-", "")) %>%
    # Keep only unique characters
    unique() %>%
    # Collapse into comma-separated string
    paste(collapse = ",")
}

factor_other_last <- function(x) {
  # Convert to character to avoid issues with existing factor levels
  x_char <- as.character(x)
  
  # Get all unique values except "Other"
  other_levels <- setdiff(unique(x_char), "Other")
  
  # Create the new levels with "Other" at the end
  new_levels <- c(other_levels, "Other")
  
  # Return factor with correct level order
  factor(x_char, levels = new_levels)
}


```



```{r}
#| label: recreation-import
#hint the function to read in a parquet file is the same as the code to read a csv file except replace 'csv' with 'parquet'

animals<-read_parquet('../data/intermediate_files/animals.parquet')


```




```{r}
#| label: extension

animal_lactations<-read_parquet('../data/intermediate_files/animal_lactations.parquet')

animal_lacts<-animal_lactations%>%
  group_by(id_animal)%>%
  mutate(lact_min = min(lact_number), 
         lact_max = max(lact_number))%>%
  ungroup()%>%
  left_join(animals)%>%
  mutate(status_at_archive = case_when(
    is.na(date_archive)~'active',
    is.na(date_next_fresh)<1~'new lact', 
    (lact_number == 0)&(lact_max>0)~'new lact', 
     #is.na(date_dry)<1~'dry', 
    is.na(date_died)<1~'died', 
    is.na(date_sold)<1~'sold',
    is.na(date_archive)<1~'archived',
    TRUE~'ERROR')
    )

check<-animal_lacts%>%
  filter(status_at_archive %in% 'ERROR')

lact_outcomes<-animal_lacts%>%
   mutate(year_start = floor_date(date_lact_first_event, unit = 'year'))%>%

  #filters----------------------
  filter(!(year_start %in% 'unknown'))%>%
  filter(year_start>=lubridate::ymd('2019-01-01'))%>%
  #filter(!(status_at_archive %in% 'active'))%>% #use this to include or exclude actives
  
  #groups----------------------
  group_by(location_lact_list, year_start, lact_group_5)%>%
  mutate(total_lacts = n_distinct(id_animal_lact) )%>%
  ungroup()%>%
  group_by(location_lact_list, year_start, lact_group_5, status_at_archive, total_lacts)%>%
  summarize(count_lacts = n_distinct(id_animal_lact) )%>%
  ungroup()%>%
  mutate(outcome_pct = round((count_lacts/total_lacts)*100, digits = 2))%>%
  mutate(status_at_archive = factor(status_at_archive, 
                                    levels = c("new lact", "active",   "archived", "sold",  "died")))%>%
  mutate(date_start = lubridate::ymd(year_start))


test<-animal_lacts%>%
  filter(id_animal %in% '108e618-b6fb-42fe-84de-54f849_21762_08/07/16')

#colors_outcome<-c("new lact" = 'blue', "active" = 'cyan',   "archived" = 'grey30', "sold" = 'gold',  "died" = 'red')
colors_outcome<-c('Next Lact/Active' ='#018571',  "new lact" = '#018571', "active" = '#80cdc1',   "archived" = 'grey30', "sold" = '#dfc27d',  "died" = '#a6611a')



```

## plot active

```{r}
active_animals_breed<-animal_lacts%>%
  filter(status_at_archive %in% 'active')%>%
  mutate(total_animals = n_distinct(id_animal))%>%
  group_by(breed, total_animals)%>%
  summarize(ct = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(pct = ct/total_animals)%>%
  mutate(breed_simple = case_when(
    (pct<0.03)~'Other',
    TRUE~breed
  ))%>%
  select(breed, breed_simple, pct)%>%
  distinct()

list_main_breeds<-active_animals_breed%>%
  filter(pct>=0.03)%>%
  pull(breed)

list_other_breeds<-active_animals_breed%>%
  filter(pct<0.03)%>%
  pull(breed)%>%
  get_unique_chars()

```






```{r}
active_animals_counts<-animal_lacts%>%
  filter(status_at_archive %in% 'active')%>%
  left_join(active_animals_breed)%>%
  group_by(location_list, breed_simple, lact_group_5)%>%
  summarize(animal_count = n_distinct(id_animal))%>%
  ungroup()%>%
  mutate(breed_simple = factor_other_last(breed_simple))

active_animals_totals<-animal_lacts%>%
  filter(status_at_archive %in% 'active')%>%
  left_join(active_animals_breed)%>%
  group_by(location_list,  lact_group_5)%>%
  summarize(animal_count = n_distinct(id_animal))%>%
  ungroup()

ggplot(active_animals_counts)+
  geom_col(aes(x = lact_group_5, y = animal_count, fill = breed_simple))+
  geom_text(data = active_animals_totals, 
            aes(x = lact_group_5, y = animal_count, label = paste0(animal_count)), 
            vjust = 0, color = 'grey30')+
  facet_wrap(location_list~.)+
  theme_bw()+
  xlab('')+
  ylab('Number of Animals')+
  labs(title = 'Active Animal Counts', 
       caption = paste0('Other breeds include: ', list_other_breeds), 
       fill = 'Breed')+
  scale_fill_viridis_d(option = "viridis")
  


```



## plot outcomes

Overview of how disposible cows are.  

### trends - option 1

The line is just this farm, but could also display mean across mySYNCH in future.  
Could add to bi-yearly alerts if way off benchmark.

```{r}

df_plot_outcome_trends<-lact_outcomes%>%
         mutate(status_at_archive = case_when(
           (status_at_archive %in% c('new lact', 'active'))~'Next Lact/Active', 
           TRUE~status_at_archive))

df_plot_means<-df_plot_outcome_trends%>%
                    filter((date_start<(max(df_plot_outcome_trends$date_start))))%>%
                  group_by(location_lact_list, lact_group_5, year_start, date_start, status_at_archive)%>%
                  summarize(outcome_pct = sum(outcome_pct))%>%
                  ungroup()%>%
                  group_by(location_lact_list, lact_group_5,  status_at_archive)%>%
                  summarize(outcome_pct = mean(outcome_pct))%>%
                  ungroup()
           
ggplot(df_plot_outcome_trends)+
  geom_bar(aes(x = date_start, y = outcome_pct, fill = status_at_archive), 
           stat = 'identity', alpha = .6)+
    geom_smooth(data =  df_plot_outcome_trends%>%
                  filter((date_start<(max(df_plot_outcome_trends$date_start))))%>%
                  group_by(location_lact_list, lact_group_5, year_start, date_start, status_at_archive)%>%
                  summarize(outcome_pct = sum(outcome_pct))%>%
                  ungroup(), 
                aes(x = date_start, y = outcome_pct, fill = status_at_archive, color = status_at_archive), 
                #color = 'black', fill = 'black', 
                alpha = .2, se = FALSE, size = 1.5)+
  geom_hline(data = df_plot_means, 
             aes(yintercept = outcome_pct), color = 'grey30', linetype = 'dashed')+
  facet_grid(status_at_archive~lact_group_5, scales = 'free_y')+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_color_manual(values = colors_outcome)+
  scale_fill_manual(values = colors_outcome)+
  coord_cartesian(ylim = c(0, NA))+
  labs(title = 'Lactation Outcomes', 
       caption = 'Gray horizontal line is the average',
       ylab = 'Percent of Lactations (%)',
       xlab = '',
       fill = '', 
       color = '')
  
```
### stacked - option 2

Not my first pick, but visually simpler than faceting status

```{r}
ggplot(lact_outcomes%>%filter(!(year_start %in% 'unknown')))+
  geom_col(aes(x = year_start, y = outcome_pct, fill = status_at_archive))+
  facet_grid(.~lact_group_5)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_color_manual(values = colors_outcome)+
  scale_fill_manual(values = colors_outcome)
```



