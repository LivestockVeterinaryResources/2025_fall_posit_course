---
title: Week 4
date: "`r Sys.Date()`"
embed-resources: true
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(echo = TRUE)

# This chunk is already finished for you, you don't need to modify anything here
library(tidyverse) #this includes many packages and is the main package used in nearly all data wrangling
library(arrow) #this package handles parquet files
library(skimr) #this is particularly helpful when looking at new data or finding NA values
library(waldo) #we use this to create answer keys for these exercises

solution_columns<-read_rds('data_milestones/solutions_week4_check_columns.rds')

columns <- colnames(solution_columns)

#add some extra functions
source('../functions/fxn_add_event_counts.R')
source('data_milestones/fxn_floor_dates.R')


```

## Create and select columns

In this milestone, you'll write some of the code that was written for you in milestone 3.

1.  The events_formatted.parquet file is read in, named "events" in your environment, and filtered for health events. Filter this further so you only have only one or 2 unique health events. The example in the solution is based on 'NAVEL' and 'SEPTIC' events, but choose anything you want.
2.  create a new variable in events named **floordate_month**. The logic to create this variable is: **floor_date(date_event, 'months')**
3.  arrange the events by 3 variables: the animal (id_animal), the event (event), and then the event date (date_event).
4.  Pipe your events to the function fxn_add_event_counts(). This will add columns indicating the number of times the animal has had that event within the data set (event_count_animal) or within their lactation (event_count_lact). If you would like to see the code the creates these click on the function in your environment.
5.  create a new variable the is animal age in days at time of event. Name this variable "age_event"
6.  select all the variables below in the order you see them in the solution_columns table in your environment

```{r}
#| label: recreation-import


events<-read_parquet('../data/intermediate_files/events_formatted.parquet')%>%
  filter(event_type %in% 'health') |> 
  filter(event %in% (c("LAME", "MAST"))) |> 
  mutate(floordate_month = floor_date(date_event, 'months')) %>%
  arrange(id_animal, event, date_event) %>%
  fxn_add_event_counts() %>%
  mutate(age_event = as.numeric(difftime(date_event, date_birth, units = 'days'))
         )%>%
  # trick to get all of columns in solutions provided above.  See code above in first chunck
    select(all_of(columns))




```

## Check selected columns

```{r}


waldo::compare(colnames(events), colnames(solution_columns))

```

### Step 2 - Disease and Treatments

Create 2 new variables for your events: Disease and Treatment. Use case_when() and whichever columns you would like to create the best description. Then use graphs, tables, or a combination to describe the timing your selected Disease(s), both over time and according to animal age or dim as appropriate. Show if there has been a change in the treatments used over time.

Below are a couple example graphics, but yours can be prettier.

```{r}
#| label: recreate-this
#| message: false


knitr::include_graphics('images/milestone4_disease_over_time.jpg')
knitr::include_graphics('images/milestone4_disease_by_phase.jpg')



```
```{r}
#| label: recreation

# get data

# to get idea of protocols
recreate <- events |> 
  group_by(location_event, event, protocols) %>%
  count(name = "n_protocols") |> 
    arrange(desc(n_protocols)) |> 
  ungroup()

# remove trimonly
events_treated <- events |> 
  filter(!(protocols %in% c('TRIMONLY'))
         ) |> 
  # separate into unknown, no treatement, treatment
  mutate(treatment = case_when(protocols %in% c('BLANK_UNKNOWN') ~ 'Unknown',
                               protocols %in% c('No Treatment') ~ "No Treatment",
                               !protocols %in% c('No Treatment', 
                                                 'BLANK_UNKNOWN') ~ 'Treated',
                               .default = NA_character_)
         ) |> 
  mutate(treatment = fct_infreq(treatment))
  


```

# graph by time
```{r}
#| label: fig-recreate_graph_time


graph <- events_treated |> 
  ggplot(aes(x = floordate_month, fill = treatment)) +
  geom_bar() +
  labs(title = "Number of Events Over Time by Treatment Status",
       x = "Month",
       y = "Number of Events",
       fill = "Treatment Status") +
  theme_minimal()+
  theme(legend.position = "bottom")+
  scale_fill_viridis_d()+
  facet_grid(cols = vars(location_event, event), 
             rows = vars(lact_group)
             )

graph
           

  

```

# graph by dim

```{r}
#| label: fig-recreate_graph_dim

graph <- events_treated |> 
  filter(!is.na(dim_event)) |>
  filter(lact_number >0) |> 
    filter(date_event > max(date_event) - 
          lubridate::years(1)
         ) |> 
  ggplot(aes(x = dim_event, fill = treatment)) +
  geom_histogram(binwidth = 30) +
  labs(title = "DIM timing of events in last year by Treatment Status",
       x = "DIM",
       y = "Number of Events",
       fill = "Treatment Status") +
  theme_minimal()+
  theme(legend.position = "bottom")+
  scale_fill_viridis_d()+
  facet_grid(cols = vars(location_event, lact_group), 
             rows = vars(event),
             scales = "free_y"
             )

graph
```





### Extension Options

1)  Improve your description for your chosen events
2)  Choose a new disease
3)  choose to add multiple farms (either your own data or other example herds)

# @fig-extension Graph of lame event Number by lactation

```{r}
#| label: fig-extension
#| fig-cap: "Older cows mainly have repeat cases"

graph <- events_treated |> 
  filter(!is.na(dim_event)) |>
  filter(event %in% c('LAME')) |>
  filter(lact_number >0) |> 
    filter(date_event > max(date_event) - 
          lubridate::years(1)
         ) |> 
  mutate(event_count_animal_group = case_when(
    event_count_animal == 1 ~ 'First Event',
    event_count_animal == 2 ~ 'Second Event',
    event_count_animal >2 ~ '3+ Events',
    TRUE ~ 'Unknown'
  )) |>
  mutate(event_count_animal_group = factor(event_count_animal_group, 
                                       levels = c('First Event', 
                                                  'Second Event', 
                                                  '3+ Events'))) |>
  ggplot(aes(x = dim_event, fill = event_count_animal_group)) +
  geom_histogram(binwidth = 30) +
  labs(title = "DIM timing of events in last year by Treatment Status",
       x = "DIM",
       y = "Number of Events",
       fill = "Event number") +
  theme_minimal()+
  theme(legend.position = "none")+
  scale_fill_viridis_d()+
  facet_grid(cols = vars(location_event, lact_group), 
             rows = vars(event_count_animal_group),
             scales = "free_y"
             )

graph

```

